;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;  Midifile-Interface.lisp;;;;  Copyright (c) 1999,2000 GRAME.  All rights reserved.;;;;  ;;   Interface to the MidiFile library;;;;   15/01/99 : Version 1.0 ;;   06/12/00 : ajout des points d'entree bas niveaux : MidiFileOpen, MidiFileCreate....;;   21/06/01 : Ajout de fonctions de creation/destruction make-midifile-infos et free-midifile-infos;;   07/07/04 : Renommage pour eviter des conflits avec Player-Interface.lisp;;   ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;-------------------------------------------------------------------------- ;; MIDIfile  ;;-------------------------------------------------------------------------- (defparameter clce-midifile0  0)(defparameter clce-midifile1  1)(defparameter clce-midifile2  2)(defparameter clce-TicksPerQuarterNote	0)(defparameter clce-Smpte24		24)(defparameter clce-Smpte25		25)(defparameter clce-Smpte29		29)(defparameter clce-Smpte30		30) ;;--------------------------------------------------------------------------  ;; Errors  :  for MidiFile ;;-------------------------------------------------------------------------- (defparameter clce-noErr	        0)		;; no error 						 (defparameter clce-ErrOpen	        1)		;; file open error 	 (defparameter clce-ErrRead		2)		;; file read error	 (defparameter clce-ErrWrite		3)		;; file write error	 (defparameter clce-ErrVol	        4)		;; Volume error 	 (defparameter clce-ErrGetInfo 		5)		;; GetFInfo error	 (defparameter clce-ErrSetInfo		6)		;; SetFInfo error	 (defparameter clce-ErrMidiFileFormat	7)	        ;; bad MidiFile format	 ;; constantes diverses(defparameter clce-MidiFileReadMode 	0)(defparameter clce-MidiFileAppendMode 	1)(defparameter clce-MidiFileFormat0 	0)(defparameter clce-MidiFileFormat1 	1)(defparameter clce-MidiFileFormat2 	2)(defparameter clce-TicksPerQuarterNote	0)(defparameter clce-Smpte24		24)(defparameter clce-Smpte25		25)(defparameter clce-Smpte29		29)(defparameter clce-Smpte30		30);;--------------------------------------------------------------------------;; Interface for MCL on MacIntosh;;--------------------------------------------------------------------------#+(and apple mcl powerpc);; The MifiFile file must be located either in the System Folder/Extension Folder;; or in the same folder as the MidifilePPC.lisp file.(ccl::add-to-shared-library-search-path "MIDIFilesPPC")#+(and apple mcl powerpc)(progn;; Record for MidiFile;;================================(defrecord MidiFileInfos  (format  :longint)       (timedef :longint)     (clicks  :longint)        (tracks  :longint))   (defun make-midifile-infos () (make-record MidiFileInfos))(defun free-midifile-infos (info) (dispose-record  info))(defmacro clce-mf-format (e &optional (d nil d?))  (if d?    `(rset ,e :MidiFileInfos.format ,d)    `(rref ,e :MidiFileInfos.format)))(defmacro clce-mf-timedef (e &optional (d nil d?))  (if d?    `(rset ,e :MidiFileInfos.timedef ,d)    `(rref ,e :MidiFileInfos.timedef)))(defmacro clce-mf-clicks (e &optional (d nil d?))  (if d?    `(rset ,e :MidiFileInfos.clicks ,d)    `(rref ,e :MidiFileInfos.clicks)))(defmacro clce-mf-tracks (e )  `(rref ,e :MidiFileInfos.tracks)))#-:CCL-5.0b(progn  (eval-when (:compile-toplevel :load-toplevel :execute)    (defvar *clce-framework* nil)        (defun clce-framework ()      (or *clce-framework*          (setq *clce-framework*                (load-framework-bundle "CLCE.framework"))))        (clce-framework))    ;................................................................................: MidiFilesVersion(defmacro MidiFilesVersion ()  `(ccl::ppc-ff-call (get-fun-addr "CLCE_MidiFilesVersion" *clce-framework*)                      :signed-fullword));................................................................................: MidiFileSave(defmacro clce-MidiFileSave (name score infos)  ` (with-cstrs ((s ,name))      (ccl::ppc-ff-call (get-fun-addr "CLCE_MidiFileSave" *clce-framework*)                         :address s                        :address ,score                        :address ,infos                        :signed-fullword)));................................................................................: MidiFileLoad(defmacro clce-MidiFileLoad (name score infos)  ` (with-cstrs ((s ,name))      (ccl::ppc-ff-call (get-fun-addr "CLCE_MidiFileLoad" *clce-framework*)                         :address s                        :address ,score                        :address ,infos                        :signed-fullword)));................................................................................: MidiFileCountTracks(defmacro MidiFileCountTracks (name)  `(with-cstrs ((s ,name))      (ccl::ppc-ff-call (get-fun-addr "CLCE_MidiFileCountTracks" *clce-framework*)                      :address s                     :signed-fullword)));................................................................................: MidiFileCountTracks(defmacro MidiShareSave (name score)  `(with-cstrs ((s ,name))      (ccl::ppc-ff-call (get-fun-addr "CLCE_MidiShareSave" *clce-framework*)                      :address s                     :address ,score                     :signed-fullword)));................................................................................: MidiFileCountTracks(defmacro MidiShareLoad (name score)  `(with-cstrs ((s ,name))     (ccl::ppc-ff-call (get-fun-addr "CLCE_MidiShareLoad" *clce-framework*)                        :address s                       :address ,score                       :signed-fullword)));;--------------------------------- ouverture/fermeture d'un fichier ----------------------------(defmacro MidiFileOpen (name mode)  `(with-cstrs ((s ,name))     (ccl::ppc-ff-call (get-fun-addr "CLCE_MidiFileOpen" *clce-framework*)                        :address s                       :signed-fullword ,mode                       :address)))(defun MidiFileOpen1 (name val) (MidiFileOpen name val))(defmacro MidiFileCreate (name a1 a2 a3)  `(with-cstrs ((s ,name))     (ccl::ppc-ff-call (get-fun-addr "CLCE_MidiFileCreate" *clce-framework*)                        :address s                       :signed-fullword ,a1                       :signed-fullword ,a2                       :signed-fullword ,a3                       :address)))(defun MidiFileCreate1 (name a1 a2 a3) (MidiFileCreate name a1 a2 a3))(defmacro MidiFileClose (file)  `(ccl::ppc-ff-call (get-fun-addr "CLCE_MidiFileClose" *clce-framework*)                        :address ,file                       :signed-fullword));;------------------------------------ gestion des pistes du fichier ----------------------------(defmacro MidiFileOpenTrack (file)  `(ccl::ppc-ff-call (get-fun-addr "CLCE_MidiFileOpenTrack" *clce-framework*)                        :address ,file                       :signed-fullword))(defmacro MidiFileNewTrack (file)  `(ccl::ppc-ff-call (get-fun-addr "CLCE_MidiFileNewTrack" *clce-framework*)                        :address ,file                       :signed-fullword))(defmacro MidiFileCloseTrack (file)  `(ccl::ppc-ff-call (get-fun-addr "CLCE_MidiFileCloseTrack" *clce-framework*)                        :address ,file                       :signed-fullword))(defmacro MidiFileChooseTrack (file num)  `(ccl::ppc-ff-call (get-fun-addr "CLCE_MidiFileChooseTrack" *clce-framework*)                        :address ,file                       :signed-fullword, num                       :signed-fullword));;----------------------------------------- les fonctions de lecture ----------------------------(defmacro MidiFileReadEv (file)  `(ccl::ppc-ff-call (get-fun-addr "CLCE_MidiFileReadEv" *clce-framework*)                        :address ,file                       :address))(defmacro MidiFileReadTrack (file)  `(ccl::ppc-ff-call (get-fun-addr "CLCE_MidiFileReadTrack" *clce-framework*)                        :address ,file                       :address));----------------------------------------- les fonctions d'ecriture ----------------------------(defmacro MidiFileWriteEv (file ev)  `(ccl::ppc-ff-call (get-fun-addr "CLCE_MidiFileWriteEv" *clce-framework*)                        :address ,file                       :address ,ev                       :signed-fullword))(defmacro MidiFileWriteTrack (file seq)  `(ccl::ppc-ff-call (get-fun-addr "CLCE_MidiFileWriteTrack" *clce-framework*)                      :address ,file                     :address ,seq                     :signed-fullword))(defun midifile-c-load (name score info)  (clce-MidiFileLoad name score info))(defun midifile-c-save (name score info)  (clce-MidiFileSave name score info))(defun MidiFile-Count-Tracks (name)  (MidiFileCountTracks name))(defun MidiShare-c-Save (name score)  (MidiShareSave name score))(defun MidiShare-c-Load (name score)  (MidiShareLoad name score)))#-:CCL-4.3.1(progn;; Midifile management;;====================(define-entry-point ("MidiFilesVersion" ("MIDIFilesPPC")) () :long)(define-entry-point ("MidiFileSave" ("MIDIFilesPPC")) (( name :ptr) (score :ptr) (infos :ptr)) :long)(define-entry-point ("MidiFileLoad" ("MIDIFilesPPC")) (( name :ptr) (score :ptr) (infos :ptr)) :long)(define-entry-point ("MidiFileCountTracks" ("MIDIFilesPPC")) (( name :ptr)) :long)(define-entry-point ("MidiShareSave" ("MIDIFilesPPC")) (( name :ptr) (score :ptr)) :long)(define-entry-point ("MidiShareLoad" ("MIDIFilesPPC")) (( name :ptr) (score :ptr)) :long);;--------------------------------- ouverture/fermeture d'un fichier ----------------------------;midiFILE  *MidiFileOpen( const char *filename, short mode);(define-entry-point  ("MidiFileOpen"  ("MIDIFilesPPC")) ( (string :ptr) (fixnum :long) ) :ptr)(defun MidiFileOpen1 (name val)  (with-cstrs  ((cstr name))    (MidiFileOpen cstr val)));midiFILE  *MidiFileCreate( const char *filename, short format, short timeDef, short ticks);(define-entry-point  ("MidiFileCreate"  ("MIDIFilesPPC"))  ((string :ptr) (fixnum :long) (fixnum :long) (fixnum :long)) :ptr)(defun MidiFileCreate1 (name v1 v2 v3)  (with-cstrs ((cstr name))    (MidiFileCreate cstr v1 v2 v3)));Boolean    MidiFileClose( register midiFILE *fd);(define-entry-point  ("MidiFileClose"  ("MIDIFilesPPC")) ( (macptr :ptr) ) :long);;------------------------------------ gestion des pistes du fichier ----------------------------;Boolean    MidiFileOpenTrack( midiFILE *fd);(define-entry-point  ("MidiFileOpenTrack"  ("MIDIFilesPPC"))	( (macptr :ptr) ) :long);Boolean    MidiFileNewTrack( midiFILE *fd);(define-entry-point  ("MidiFileNewTrack"  ("MIDIFilesPPC"))	( (macptr :ptr) ) :long);Boolean    MidiFileCloseTrack( midiFILE *fd);(define-entry-point  ("MidiFileCloseTrack"  ("MIDIFilesPPC"))	( (macptr :ptr) ) :long);Boolean    MidiFileChooseTrack( midiFILE *fd, short numPiste);(define-entry-point  ("MidiFileChooseTrack"  ("MIDIFilesPPC")) 	( (macptr :ptr) (fixnum :long) ) :long);;----------------------------------------- les fonctions de lecture ----------------------------;MidiEvPtr  MidiFileReadEv( midiFILE *fd);(define-entry-point  ("MidiFileReadEv"  ("MIDIFilesPPC"))  ( (macptr :ptr) ) :ptr);MidiSeqPtr MidiFileReadTrack( midiFILE *fd);(define-entry-point  ("MidiFileReadTrack"  ("MIDIFilesPPC"))  	( (macptr :ptr) ) :ptr);;----------------------------------------- les fonctions d'ecriture ----------------------------;Boolean    MidiFileWriteEv( midiFILE *fd, MidiEvPtr ev);(define-entry-point  ("MidiFileWriteEv"  ("MIDIFilesPPC")) 	( (macptr :ptr) (macptr :ptr) ) :long);Boolean    MidiFileWriteTrack( midiFILE *fd, MidiSeqPtr seq);(define-entry-point  ("MidiFileWriteTrack"  ("MIDIFilesPPC")) 	( (macptr :ptr) (macptr :ptr) ) :long);;-------------------------------------------(defun midifile-c-load (name score info)  (with-pstrs ((cstr name))    (MidiFileLoad cstr score info)))(defun midifile-c-save (name score info)  (with-pstrs ((cstr name))   (print (MidiFileSave cstr score info))))(defun MidiFile-Count-Tracks (name)  (with-pstrs ((cstr name))    (MidiFileCountTracks cstr)))(defun MidiShare-c-Save (name score)  (with-pstrs ((cstr name))    (MidiShareSave cstr score)))(defun MidiShare-c-Load (name score)  (with-pstrs ((cstr name))    (MidiShareLoad cstr score))))    ;; End of MCL interface;;---------------------------------------------------------------------------------;; 			    Interface for CMULisp on Linux;;---------------------------------------------------------------------------------#+(and linux cmu);; The MifiFile file must be located either in the System Folder/Extension Folder;; or in the same folder as the Midifile-Interface.lisp file.(eval-when (:compile-toplevel :load-toplevel :execute)  (let ((*warn-if-redefine* nil))    (load-foreign "/usr/lib/libCLCE.so"  )                (use-package "ALIEN"                 )    (use-package "C-CALL"                )  ))#+(and linux cmu)(progn(def-alien-type ptr (* t)) (def-alien-type MidiFilePtr (* t));; Record for MidiFile;;================================(def-alien-type nil    (struct MidiFileInfos    (format  long)         (timedef long)       (clicks  long)          (tracks  long)  ))(defun make-midifile-infos () (make-alien (struct MidiFileInfos)))(defun free-midifile-infos (info) (free-alien info))(defmacro  mf-format (e &optional (d nil d?))    (if d?    `(setf (slot ,e 'format) ,d)    `(slot ,e 'format          )  )) (defmacro mf-timedef (e &optional (d nil d?))  (if d?    `(setf (slot ,e 'timedef) ,d)    `(slot ,e 'timedef          )  ))(defmacro mf-clicks (e &optional (d nil d?))   (if d?    `(setf (slot ,e 'clicks) ,d)    `(slot ,e 'clicks          )  ))(defmacro mf-tracks (e)   `(slot ,e 'tracks))(def-alien-type MidiFileInfosPtr (* (struct MidiFileInfos) ) ) ;; Midifile management;;====================(declaim (inline MidiFilesVersion))(def-alien-routine "MidiFilesVersion" long )(declaim (inline MidiFileSave))(def-alien-routine "MidiFileSave" long   ( name c-string) (score ptr) (infos MidiFileInfosPtr))(declaim (inline MidiFileLoad))(def-alien-routine "MidiFileLoad" long   ( name c-string) (score ptr) (infos MidiFileInfosPtr))(declaim (inline MidiFileCountTracks))(def-alien-routine "MidiFileCountTracks" long   ( name c-string)) (declaim (inline MidiShareSave))(def-alien-routine "MidiShareSave" long    ( name c-string) (score ptr))(declaim (inline MidishareLoad))(def-alien-routine "MidiShareLoad" long    ( name c-string) (score ptr));;--------------------------------- ouverture/fermeture d'un fichier ----------------------------;midiFILE  *MidiFileOpen( const char *filename, short mode);(declaim (inline MidiFileOpen))(def-alien-routine "MidiFileOpen" MidiFilePtr   (string c-string) (fixnum short))(defun MidiFileOpen1 (name val)   (MidiFileOpen name val));midiFILE  *MidiFileCreate( const char *filename, short format, short timeDef, short ticks);(declaim (inline MidiFileCreate))(def-alien-routine "MidiFileCreate" MidiFilePtr   (string c-string) (fixnum1 short) (fixnum2 short) (fixnum3 short))(defun MidiFileCreate1 (name v1 v2 v3)   (MidiFileCreate name v1 v2 v3));Boolean    MidiFileClose( register midiFILE *fd);(declaim (inline MidiFileClose))(def-alien-routine "MidiFileClose" char    (macptr MidiFilePtr));;------------------------------------ gestion des pistes du fichier ----------------------------;Boolean    MidiFileOpenTrack( midiFILE *fd);(declaim (inline MidiFileOpenTrack))(def-alien-routine "MidiFileOpenTrack" char   (macptr MidiFilePtr));Boolean    MidiFileNewTrack( midiFILE *fd);(declaim (inline MidiFileNewTrack))(def-alien-routine "MidiFileNewTrack" char    (macptr MidiFilePtr));Boolean    MidiFileCloseTrack( midiFILE *fd);(declaim (inline MidiFileCloseTrack))(def-alien-routine "MidiFileCloseTrack" char    (macptr MidifilePtr));Boolean    MidiFileChooseTrack( midiFILE *fd, short numPiste);(declaim (inline MidiFileChooseTrack))(def-alien-routine "MidiFileChooseTrack" char   (macptr MidiFilePtr) (fixnum short));;----------------------------------------- les fonctions de lecture ----------------------------;MidiEvPtr  MidiFileReadEv( midiFILE *fd);(declaim (inline MidiFileReadEv))(def-alien-routine "MidiFileReadEv" MidiEvPtr   (macptr MidiFilePtr));MidiSeqPtr MidiFileReadTrack( midiFILE *fd);(declaim (inline MidiFileReadTrack))(def-alien-routine "MidiFileReadTrack" MidiSeqPtr   (macptr MidiFilePtr));;----------------------------------------- les fonctions d'écriture ----------------------------;Boolean    MidiFileWriteEv( midiFILE *fd, MidiEvPtr ev);(declaim (inline MidiFileWriteEv))(def-alien-routine  "MidiFileWriteEv" char    (macptr1 MidiFilePtr) (macptr2 MidiEvPtr));Boolean    MidiFileWriteTrack( midiFILE *fd, MidiSeqPtr seq);(declaim (inline MidiFileWriteTrack))(def-alien-routine  "MidiFileWriteTrack" char   (macptr1 MidiFilePtr) (macptr2 MidiSeqPtr));;-------------------------------------------(defun midifile-c-load (name score info)   (MidiFileLoad name score info))(defun midifile-c-save (name score info)   (print (MidiFileSave name score info)))(defun MidiFile-Count-Tracks (name)   (MidiFileCountTracks name))(defun MidiShare-c-Save (name score)  (MidiShareSave name score)) (defun MidiShare-c-Load (name score)  (MidiShareLoad name score)))    ;; End of CMULisp interface